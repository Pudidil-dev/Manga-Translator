const n={backendUrl:"http://127.0.0.1:5000",sourceLang:"ja",targetLang:"id",useSam:!1,useAdvanced:!1,detectOsb:!0,useInpainting:!0,inpaintMethod:"opencv",renderText:!0,batchSize:4};chrome.runtime.onMessage.addListener((e,r,t)=>(c(e).then(t).catch(a=>t({success:!1,error:a.message})),!0));async function c(e,r){const t=await o();switch(e.action){case"checkHealth":return u(t);case"translate":return i(t,e.data);case"translateBatch":return l(t,e.data);case"fetchImageAsBase64":return d(e.data.url);case"getSettings":return{success:!0,settings:t};case"saveSettings":return await chrome.storage.local.set({settings:e.data}),{success:!0};default:return{success:!1,error:"Unknown action"}}}async function o(){const e=await chrome.storage.local.get("settings");return{...n,...e.settings}}async function u(e){try{const r=await fetch(`${e.backendUrl}/api/health`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return{success:!0,health:await r.json()}}catch(r){return{success:!1,error:r.message}}}async function i(e,r){try{const t=await fetch(`${e.backendUrl}/api/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_b64:r.imageBase64,source_lang:r.sourceLang||e.sourceLang,target_lang:r.targetLang||e.targetLang,use_sam:r.useSam??e.useSam,use_advanced:r.useAdvanced??e.useAdvanced,detect_osb:r.detectOsb??e.detectOsb,use_inpainting:r.useInpainting??e.useInpainting,inpaint_method:r.inpaintMethod||e.inpaintMethod,render_text:r.renderText??e.renderText,return_image:!0})});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.json();return a.success?{success:!0,regions:a.regions||[],image_b64:a.image_b64,meta:a.meta||{}}:{success:!1,error:a.error||"Translation failed"}}catch(t){return{success:!1,error:t.message}}}async function l(e,r){try{const t=await fetch(`${e.backendUrl}/api/batch_translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({images:r.images,source_lang:r.source_lang||e.sourceLang,target_lang:r.target_lang||e.targetLang,detect_osb:r.detect_osb??e.detectOsb,use_inpainting:r.use_inpainting??e.useInpainting,inpaint_method:r.inpaint_method||e.inpaintMethod,use_sam:r.use_sam??e.useSam,use_advanced:r.use_advanced??e.useAdvanced,render_text:r.render_text??e.renderText})});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.json();return a.success?{success:!0,results:a.results||[],meta:a.meta||{}}:{success:!1,error:a.error||"Batch translation failed"}}catch(t){return{success:!1,error:t.message}}}async function d(e){try{const r=await fetch(e);if(!r.ok)throw new Error(`HTTP ${r.status}`);const t=await r.blob();return new Promise(a=>{const s=new FileReader;s.onloadend=()=>{a({success:!0,base64:s.result})},s.onerror=()=>{a({success:!1,error:"Failed to read blob"})},s.readAsDataURL(t)})}catch(r){return{success:!1,error:r.message}}}console.log("[MangaTranslate] Background service worker started (Unified API + Batch)");
