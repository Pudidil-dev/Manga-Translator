const n={backendUrl:"http://127.0.0.1:5000",sourceLang:"ja",targetLang:"id",useSam:!1,useAdvanced:!1,detectOsb:!0,useInpainting:!0,inpaintMethod:"opencv",renderText:!0};chrome.runtime.onMessage.addListener((r,e,t)=>(c(r).then(t).catch(s=>t({success:!1,error:s.message})),!0));async function c(r,e){const t=await o();switch(r.action){case"checkHealth":return u(t);case"translate":return i(t,r.data);case"fetchImageAsBase64":return l(r.data.url);case"getSettings":return{success:!0,settings:t};case"saveSettings":return await chrome.storage.local.set({settings:r.data}),{success:!0};default:return{success:!1,error:"Unknown action"}}}async function o(){const r=await chrome.storage.local.get("settings");return{...n,...r.settings}}async function u(r){try{const e=await fetch(`${r.backendUrl}/api/health`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);return{success:!0,health:await e.json()}}catch(e){return{success:!1,error:e.message}}}async function i(r,e){try{const t=await fetch(`${r.backendUrl}/api/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_b64:e.imageBase64,source_lang:e.sourceLang||r.sourceLang,target_lang:e.targetLang||r.targetLang,use_sam:e.useSam??r.useSam,use_advanced:e.useAdvanced??r.useAdvanced,detect_osb:e.detectOsb??r.detectOsb,use_inpainting:e.useInpainting??r.useInpainting,inpaint_method:e.inpaintMethod||r.inpaintMethod,render_text:e.renderText??r.renderText,return_image:!0})});if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.json();return s.success?{success:!0,regions:s.regions||[],image_b64:s.image_b64,meta:s.meta||{}}:{success:!1,error:s.error||"Translation failed"}}catch(t){return{success:!1,error:t.message}}}async function l(r){try{const e=await fetch(r);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.blob();return new Promise(s=>{const a=new FileReader;a.onloadend=()=>{s({success:!0,base64:a.result})},a.onerror=()=>{s({success:!1,error:"Failed to read blob"})},a.readAsDataURL(t)})}catch(e){return{success:!1,error:e.message}}}console.log("[MangaTranslate] Background service worker started (Unified API)");
