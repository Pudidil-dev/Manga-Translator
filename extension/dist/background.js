const n={backendUrl:"http://127.0.0.1:5000",sourceLang:"ja",targetLang:"id"};chrome.runtime.onMessage.addListener((t,r,e)=>(c(t).then(e).catch(s=>e({success:!1,error:s.message})),!0));async function c(t,r){const e=await o();switch(t.action){case"checkHealth":return u(e);case"translateImage":return l(e,t.data);case"batchDetect":return i(e,t.data);case"batchTranslate":return g(e,t.data);case"fetchImageAsBase64":return h(t.data.url);case"getSettings":return{success:!0,settings:e};case"saveSettings":return await chrome.storage.local.set({settings:t.data}),{success:!0};case"updateProgress":return{success:!0};default:return{success:!1,error:"Unknown action"}}}async function o(){const t=await chrome.storage.local.get("settings");return{...n,...t.settings}}async function u(t){try{const r=await fetch(`${t.backendUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return{success:!0,health:await r.json()}}catch(r){return{success:!1,error:r.message}}}async function l(t,r){try{const e=await fetch(`${t.backendUrl}/v1/translate_viewport`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_b64:r.imageBase64,source_lang:r.sourceLang||t.sourceLang,target_lang:r.targetLang||t.targetLang})});if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.json();return{success:!0,regions:s.regions||[],meta:s.meta||{}}}catch(e){return{success:!1,error:e.message}}}async function i(t,r){try{const e=await fetch(`${t.backendUrl}/v1/batch_detect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({images:r.images,source_lang:r.sourceLang||t.sourceLang})});if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.json();return{success:!0,bubbles:s.bubbles||[],meta:{total_images:s.total_images,total_bubbles:s.total_bubbles,detect_ms:s.detect_ms,ocr_ms:s.ocr_ms}}}catch(e){return{success:!1,error:e.message}}}async function g(t,r){try{const e=await fetch(`${t.backendUrl}/v1/batch_translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bubbles:r.bubbles,source_lang:r.sourceLang||t.sourceLang,target_lang:r.targetLang||t.targetLang})});if(!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.json();return{success:!0,bubbles:s.bubbles||[],meta:{total_translated:s.total_translated,translate_ms:s.translate_ms,cached_hits:s.cached_hits}}}catch(e){return{success:!1,error:e.message}}}async function h(t){try{const r=await fetch(t);if(!r.ok)throw new Error(`HTTP ${r.status}`);const e=await r.blob(),s=new FileReader;return new Promise(a=>{s.onloadend=()=>{a({success:!0,base64:s.result})},s.onerror=()=>{a({success:!1,error:"Failed to read blob"})},s.readAsDataURL(e)})}catch(r){return{success:!1,error:r.message}}}console.log("[MangaTranslate] Background service worker started");
