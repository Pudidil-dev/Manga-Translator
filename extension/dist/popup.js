const o=document.getElementById("sourceLang"),l=document.getElementById("targetLang"),u=document.getElementById("backendUrl"),g=document.getElementById("detectOsb"),i=document.getElementById("useInpainting"),h=document.getElementById("inpaintMethod"),f=document.getElementById("inpaintMethodGroup"),m=document.getElementById("useSam"),y=document.getElementById("useAdvanced"),E=document.getElementById("renderText"),s=document.getElementById("translateBtn"),I=document.getElementById("toggleBtn"),b=document.getElementById("clearBtn"),L=document.getElementById("statusText"),w=document.getElementById("progressFill"),k=document.getElementById("stats"),M=document.getElementById("advancedHeader"),d=document.getElementById("advancedContent");async function S(){const e=await chrome.runtime.sendMessage({action:"getSettings"});if(e!=null&&e.success){const t=e.settings;o.value=t.sourceLang||"ja",l.value=t.targetLang||"id",u.value=t.backendUrl||"http://127.0.0.1:5000",g.checked=t.detectOsb??!0,i.checked=t.useInpainting??!0,h.value=t.inpaintMethod||"opencv",m.checked=t.useSam??!1,y.checked=t.useAdvanced??!1,E.checked=t.renderText??!0,B()}}async function a(){const e={sourceLang:o.value,targetLang:l.value,backendUrl:u.value,detectOsb:g.checked,useInpainting:i.checked,inpaintMethod:h.value,useSam:m.checked,useAdvanced:y.checked,renderText:E.checked};await chrome.runtime.sendMessage({action:"saveSettings",data:e})}function B(){i.checked?f.style.display="flex":f.style.display="none"}function n(e,t=0){L.textContent=e,w.style.width=`${t}%`}async function x(){n("Checking backend...",0);const e=await chrome.runtime.sendMessage({action:"checkHealth"});e!=null&&e.success?e.health.ok?(n("Backend ready",100),s.disabled=!1):(n("Backend unhealthy",0),s.disabled=!0):(n("Backend offline",0),s.disabled=!0)}async function r(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e||null}async function T(){await a();const e=await r();if(!(e!=null&&e.id)){n("No active tab",0);return}s.disabled=!0,n("Starting translation...",10);try{await chrome.tabs.sendMessage(e.id,{action:"translatePage"}),n("Translation started",20)}catch(t){n(`Error: ${t.message}`,0),s.disabled=!1}}async function C(){const e=await r();if(e!=null&&e.id)try{const t=await chrome.tabs.sendMessage(e.id,{action:"toggleOverlay"});t!=null&&t.success&&n(t.showingTranslated?"Showing translated":"Showing original",100)}catch(t){n(`Error: ${t.message}`,0)}}async function O(){const e=await r();if(e!=null&&e.id)try{await chrome.tabs.sendMessage(e.id,{action:"clearOverlays"}),n("Cleared",0)}catch(t){n(`Error: ${t.message}`,0)}}async function v(){const e=await r();if(e!=null&&e.id)try{const t=await chrome.tabs.sendMessage(e.id,{action:"getStats"});if(t!=null&&t.success){const{stats:c,isProcessing:p}=t;k.textContent=`${c.showingTranslated}/${c.total} translated`,p||(s.disabled=!1)}}catch{k.textContent=""}}function $(){d.style.display==="none"?d.style.display="block":d.style.display="none"}chrome.runtime.onMessage.addListener(e=>{e.action==="updateProgress"&&(n(e.data.message,e.data.percent),e.data.percent>=100&&(s.disabled=!1,v()))});s.addEventListener("click",T);I.addEventListener("click",C);b.addEventListener("click",O);M.addEventListener("click",$);o.addEventListener("change",a);l.addEventListener("change",a);u.addEventListener("blur",a);g.addEventListener("change",a);i.addEventListener("change",()=>{B(),a()});h.addEventListener("change",a);m.addEventListener("change",a);y.addEventListener("change",a);E.addEventListener("change",a);d.style.display="none";S();x();v();setInterval(v,2e3);
