var N=Object.defineProperty;var H=(r,e,t)=>e in r?N(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var d=(r,e,t)=>H(r,typeof e!="symbol"?e+"":e,t);class P{constructor(){d(this,"memoryCache",new Map);d(this,"maxMemoryItems",50);d(this,"MIN_TEXT_GAP",4);d(this,"MIN_FONT_SIZE",8);d(this,"MAX_FONT_SIZE",28)}async renderAndCache(e,t,a){console.log("[MangaTranslate Cache] Rendering image:",a,"with",t.length,"regions");const s=document.createElement("canvas");s.width=e.naturalWidth,s.height=e.naturalHeight;const n=s.getContext("2d");if(!n)throw new Error("Failed to get canvas context");try{n.drawImage(e,0,0),console.log("[MangaTranslate Cache] Original image drawn on canvas")}catch(l){throw console.error("[MangaTranslate Cache] Failed to draw image on canvas:",l),l}const i=[...t].sort((l,u)=>l.bbox[1]-u.bbox[1]);for(const l of i)this.drawMask(n,l);const o=this.optimizeFontSizes(n,i);for(const l of o)this.renderText(n,l);console.log("[MangaTranslate Cache] All bubbles rendered");const h=await this.canvasToBlob(s),c=URL.createObjectURL(h);return console.log("[MangaTranslate Cache] Created blob URL:",c),this.memoryCache.set(a,{originalSrc:e.src,translatedBlob:h,translatedUrl:c,regions:t,width:e.naturalWidth,height:e.naturalHeight,timestamp:Date.now()}),this.enforceMemoryLimit(),c}optimizeFontSizes(e,t){var n,i;const a=[],s=[];for(const o of t){const[h,c,l,u]=o.bbox,y=o.tgt_text;if(!y||y.trim().length===0){a.push(o);continue}const m=this.getAvailableWidth(o),L=this.getAvailableHeight(o);let g=Math.min(((n=o.render)==null?void 0:n.font_size)||14,this.MAX_FONT_SIZE,Math.floor(L/3),Math.floor(m/3)),p=null;for(;g>=this.MIN_FONT_SIZE;){e.font=`500 ${g}px "Noto Sans", "Segoe UI", Arial, sans-serif`;const C=g*(((i=o.render)==null?void 0:i.line_height)||1.2),b=this.wrapText(e,y,m*.9),w=b.length*C;if(w<=L*.9){const f=Math.max(...b.map(x=>e.measureText(x).width)),I=h+l/2,E=c+u/2;if(p={x:I-f/2-this.MIN_TEXT_GAP,y:E-w/2-this.MIN_TEXT_GAP,width:f+this.MIN_TEXT_GAP*2,height:w+this.MIN_TEXT_GAP*2,regionId:o.id},!s.some(x=>this.checkCollision(p,x)))break}g-=1}p&&g>=this.MIN_FONT_SIZE&&s.push(p),a.push({...o,render:{...o.render,font_size:Math.max(g,this.MIN_FONT_SIZE)}})}return a}checkCollision(e,t){return!(e.x+e.width<t.x||t.x+t.width<e.x||e.y+e.height<t.y||t.y+t.height<e.y)}getAvailableWidth(e){const[,,t]=e.bbox;switch(e.mask_type){case"ellipse":return t*.7;case"rect":return t*.85;default:return t*.75}}getAvailableHeight(e){const[,,,t]=e.bbox;switch(e.mask_type){case"ellipse":return t*.65;case"rect":return t*.85;default:return t*.7}}drawMask(e,t){const[a,s,n,i]=t.bbox,o=a+n/2,h=s+i/2;if(e.save(),e.fillStyle="#FFFFFF",t.polygon&&t.polygon.length>=3){e.beginPath(),e.moveTo(t.polygon[0][0],t.polygon[0][1]);for(let c=1;c<t.polygon.length;c++)e.lineTo(t.polygon[c][0],t.polygon[c][1]);e.closePath(),e.fill()}else switch(t.mask_type){case"rect":e.fillRect(a+2,s+2,n-4,i-4);break;case"ellipse":default:e.beginPath(),e.ellipse(o,h,n/2*.92,i/2*.92,0,0,Math.PI*2),e.fill();break}e.restore()}renderText(e,t){var b,w;const[a,s,n,i]=t.bbox,o=a+n/2,h=s+i/2,c=t.tgt_text;if(!c||c.trim().length===0)return;const l=Math.max(((b=t.render)==null?void 0:b.font_size)||14,this.MIN_FONT_SIZE),u=l*(((w=t.render)==null?void 0:w.line_height)||1.2);e.save(),e.fillStyle="#000000",e.font=`500 ${l}px "Noto Sans", "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle";const y=this.getAvailableWidth(t),m=this.wrapText(e,c,y),L=m.length*u,g=this.getAvailableHeight(t),p=Math.min(L,g),C=h-p/2+u/2;for(let f=0;f<m.length;f++){const I=C+f*u;I<s+i*.1||I>s+i*.9||e.fillText(m[f],o,I)}e.restore()}wrapText(e,t,a){return!t||t.trim().length===0?[]:/[\u3000-\u9fff\uac00-\ud7af]/.test(t)?this.wrapCJKText(e,t,a):this.wrapLatinText(e,t,a)}wrapCJKText(e,t,a){const s=[];let n="";for(const i of t){if(i===`
`){n&&s.push(n),n="";continue}const o=n+i;e.measureText(o).width>a&&n.length>0?(s.push(n),n=i):n=o}return n&&s.push(n),s}wrapLatinText(e,t,a){const s=t.replace(/\n/g," ").split(/\s+/).filter(o=>o.length>0),n=[];let i="";for(const o of s){const h=i?`${i} ${o}`:o;if(e.measureText(h).width>a&&i.length>0)if(n.push(i),e.measureText(o).width>a){const l=this.breakLongWord(e,o,a);n.push(...l.slice(0,-1)),i=l[l.length-1]||""}else i=o;else i=h}return i&&n.push(i),n}breakLongWord(e,t,a){const s=[];let n="";for(const i of t){const o=n+i;e.measureText(o).width>a&&n.length>0?(s.push(n),n=i):n=o}return n&&s.push(n),s}canvasToBlob(e){return new Promise((t,a)=>{e.toBlob(s=>{s?t(s):a(new Error("Failed to create blob from canvas"))},"image/png",1)})}get(e){const t=this.memoryCache.get(e);return t?(t.timestamp=Date.now(),t.translatedUrl):null}getOriginal(e){var t;return((t=this.memoryCache.get(e))==null?void 0:t.originalSrc)||null}has(e){return this.memoryCache.has(e)}enforceMemoryLimit(){if(this.memoryCache.size<=this.maxMemoryItems)return;const e=Array.from(this.memoryCache.entries()).sort((a,s)=>a[1].timestamp-s[1].timestamp),t=e.slice(0,e.length-this.maxMemoryItems);for(const[a,s]of t)URL.revokeObjectURL(s.translatedUrl),this.memoryCache.delete(a)}clear(){for(const e of this.memoryCache.values())URL.revokeObjectURL(e.translatedUrl);this.memoryCache.clear()}getStats(){return{count:this.memoryCache.size,maxItems:this.maxMemoryItems}}}class U{constructor(){d(this,"cache");d(this,"replacedImages",new Map);this.cache=new P}async replaceWithBase64(e,t,a,s){try{const n=this.replacedImages.get(e);if(n!=null&&n.isShowingTranslated)return!0;const i=(n==null?void 0:n.originalSrc)||e.src;let o=this.cache.get(s);return o||(o=await this.cache.renderAndCache(t,a,s)),o?(e.src=o,this.replacedImages.set(e,{hash:s,originalSrc:i,isShowingTranslated:!0}),e.classList.remove("manga-processing","manga-original"),e.classList.add("manga-translated"),e.dataset.translationHash=s,console.log("[MangaTranslate] Image replaced successfully:",s),!0):(console.error("[MangaTranslate] Failed to render translated image"),!1)}catch(n){return console.error("[MangaTranslate] Failed to replace image:",n),!1}}async replace(e,t,a){return this.replaceWithBase64(e,e,t,a)}restore(e){const t=this.replacedImages.get(e);return t?(e.src=t.originalSrc,t.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original"),!0):!1}toggle(e){const t=this.replacedImages.get(e);if(!t)return!1;if(t.isShowingTranslated)e.src=t.originalSrc,t.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original");else{const a=this.cache.get(t.hash);a&&(e.src=a,t.isShowingTranslated=!0,e.classList.add("manga-translated"),e.classList.remove("manga-original"))}return t.isShowingTranslated}toggleAll(){let e=!1;for(const a of this.replacedImages.values())if(a.isShowingTranslated){e=!0;break}const t=!e;for(const[a,s]of this.replacedImages)if(t&&!s.isShowingTranslated){const n=this.cache.get(s.hash);n&&(a.src=n,s.isShowingTranslated=!0,a.classList.add("manga-translated"),a.classList.remove("manga-original"))}else!t&&s.isShowingTranslated&&(a.src=s.originalSrc,s.isShowingTranslated=!1,a.classList.remove("manga-translated"),a.classList.add("manga-original"));return t}restoreAll(){for(const[e]of this.replacedImages)this.restore(e);this.replacedImages.clear(),this.cache.clear()}isReplaced(e){return this.replacedImages.has(e)}isShowingTranslated(e){var t;return((t=this.replacedImages.get(e))==null?void 0:t.isShowingTranslated)||!1}getStats(){let e=0,t=0;for(const a of this.replacedImages.values())a.isShowingTranslated?e++:t++;return{total:this.replacedImages.size,showingTranslated:e,showingOriginal:t,cache:this.cache.getStats()}}}const T=new U;let M=!1,A="ja",k="id",_=0,v=0;function O(r){const e=`${r.src}_${r.naturalWidth}_${r.naturalHeight}`;let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t=t&t;return Math.abs(t).toString(16)}function W(){const r=document.querySelectorAll("img"),e=[];return r.forEach(t=>{if(!t.complete||t.naturalWidth===0||t.naturalWidth<300||t.naturalHeight<400||t.width<100||t.height<100||t.src.startsWith("data:")&&t.src.length<1e3)return;const a=t.naturalWidth/t.naturalHeight;a<.3||a>1.5||T.isReplaced(t)||e.push(t)}),e}async function B(r){const e=await chrome.runtime.sendMessage({action:"fetchImageAsBase64",data:{url:r.src}});if(e!=null&&e.success&&e.base64)return e.base64;try{const t=document.createElement("canvas");return t.width=r.naturalWidth,t.height=r.naturalHeight,t.getContext("2d").drawImage(r,0,0),t.toDataURL("image/png")}catch{throw new Error("Could not convert image (CORS blocked)")}}function R(r){return new Promise((e,t)=>{const a=new Image;a.onload=()=>e(a),a.onerror=()=>t(new Error("Failed to load image from base64")),a.src=r})}async function z(r){var t;const e=O(r);try{const a=await B(r),s=await chrome.runtime.sendMessage({action:"translateImage",data:{imageHash:e,imageBase64:a,sourceLang:A,targetLang:k}});if(!(s!=null&&s.success))return console.log("[MangaTranslate] Translation failed:",s==null?void 0:s.error),!1;if(!((t=s.regions)!=null&&t.length))return console.log("[MangaTranslate] No text regions found in image"),!1;const n=await R(a);return await T.replaceWithBase64(r,n,s.regions,e)}catch(a){return console.error("[MangaTranslate] Error processing image:",a),!1}}function S(r,e){chrome.runtime.sendMessage({action:"updateProgress",data:{message:r,percent:e}})}async function $(){if(M)return;M=!0,S("Finding images...",0);const r=W();if(r.length===0){S("No manga images found",100),M=!1;return}_=r.length,v=0,S(`Found ${_} images, starting translation...`,5);const e=2;for(let a=0;a<r.length;a+=e){const s=r.slice(a,a+e);await Promise.all(s.map(async n=>{const i=await z(n);v++,S(`Translating ${v}/${_}${i?"":" (skipped)"}`,Math.round(v/_*100))}))}const t=T.getStats();S(`Done! ${t.showingTranslated} images translated`,100),M=!1}chrome.runtime.onMessage.addListener((r,e,t)=>{switch(r.action){case"translatePage":A=r.sourceLang||"ja",k=r.targetLang||"id",$(),t({success:!0});break;case"toggleOverlay":const a=T.toggleAll();t({success:!0,showingTranslated:a});break;case"clearOverlays":T.restoreAll(),t({success:!0});break;case"getStats":t({success:!0,stats:T.getStats(),isProcessing:M});break}return!0});const F=document.createElement("style");F.textContent=`
  .manga-translated {
    outline: 2px solid #e94560;
    outline-offset: -2px;
  }
  .manga-original {
    outline: 2px dashed #888;
    outline-offset: -2px;
  }
  .manga-processing {
    outline: 2px solid #ffa500;
    outline-offset: -2px;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
`;document.head.appendChild(F);console.log("[MangaTranslate] Content script loaded");
