var W=Object.defineProperty;var z=(r,e,t)=>e in r?W(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var b=(r,e,t)=>z(r,typeof e!="symbol"?e+"":e,t);class O{constructor(){b(this,"memoryCache",new Map);b(this,"maxMemoryItems",50);b(this,"MIN_TEXT_GAP",4);b(this,"MIN_FONT_SIZE",8);b(this,"MAX_FONT_SIZE",28)}async renderAndCache(e,t,s){console.log("[MangaTranslate Cache] Rendering image:",s,"with",t.length,"regions");const n=document.createElement("canvas");n.width=e.naturalWidth,n.height=e.naturalHeight;const a=n.getContext("2d");if(!a)throw new Error("Failed to get canvas context");try{a.drawImage(e,0,0),console.log("[MangaTranslate Cache] Original image drawn on canvas")}catch(c){throw console.error("[MangaTranslate Cache] Failed to draw image on canvas:",c),c}const o=[...t].sort((c,l)=>c.bbox[1]-l.bbox[1]);for(const c of o)this.drawMask(a,c);const i=this.optimizeFontSizes(a,o);for(const c of i)this.renderText(a,c);console.log("[MangaTranslate Cache] All bubbles rendered");const h=await this.canvasToBlob(n),u=URL.createObjectURL(h);return console.log("[MangaTranslate Cache] Created blob URL:",u),this.memoryCache.set(s,{originalSrc:e.src,translatedBlob:h,translatedUrl:u,regions:t,width:e.naturalWidth,height:e.naturalHeight,timestamp:Date.now()}),this.enforceMemoryLimit(),u}optimizeFontSizes(e,t){var a,o;const s=[],n=[];for(const i of t){const[h,u,c,l]=i.bbox,d=i.tgt_text;if(!d||d.trim().length===0){s.push(i);continue}const g=this.getAvailableWidth(i),T=this.getAvailableHeight(i);let m=Math.min(((a=i.render)==null?void 0:a.font_size)||14,this.MAX_FONT_SIZE,Math.floor(T/3),Math.floor(g/3)),f=null;for(;m>=this.MIN_FONT_SIZE;){e.font=`500 ${m}px "Noto Sans", "Segoe UI", Arial, sans-serif`;const I=m*(((o=i.render)==null?void 0:o.line_height)||1.2),M=this.wrapText(e,d,g*.9),y=M.length*I;if(y<=T*.9){const p=Math.max(...M.map(x=>e.measureText(x).width)),w=h+c/2,$=u+l/2;if(f={x:w-p/2-this.MIN_TEXT_GAP,y:$-y/2-this.MIN_TEXT_GAP,width:p+this.MIN_TEXT_GAP*2,height:y+this.MIN_TEXT_GAP*2,regionId:i.id},!n.some(x=>this.checkCollision(f,x)))break}m-=1}f&&m>=this.MIN_FONT_SIZE&&n.push(f),s.push({...i,render:{...i.render,font_size:Math.max(m,this.MIN_FONT_SIZE)}})}return s}checkCollision(e,t){return!(e.x+e.width<t.x||t.x+t.width<e.x||e.y+e.height<t.y||t.y+t.height<e.y)}getAvailableWidth(e){const[,,t]=e.bbox;switch(e.mask_type){case"ellipse":return t*.7;case"rect":return t*.85;default:return t*.75}}getAvailableHeight(e){const[,,,t]=e.bbox;switch(e.mask_type){case"ellipse":return t*.65;case"rect":return t*.85;default:return t*.7}}drawMask(e,t){const[s,n,a,o]=t.bbox,i=s+a/2,h=n+o/2;if(e.save(),e.fillStyle="#FFFFFF",t.polygon&&t.polygon.length>=3){e.beginPath(),e.moveTo(t.polygon[0][0],t.polygon[0][1]);for(let u=1;u<t.polygon.length;u++)e.lineTo(t.polygon[u][0],t.polygon[u][1]);e.closePath(),e.fill()}else switch(t.mask_type){case"rect":e.fillRect(s+2,n+2,a-4,o-4);break;case"ellipse":default:e.beginPath(),e.ellipse(i,h,a/2*.92,o/2*.92,0,0,Math.PI*2),e.fill();break}e.restore()}renderText(e,t){var M,y;const[s,n,a,o]=t.bbox,i=s+a/2,h=n+o/2,u=t.tgt_text;if(!u||u.trim().length===0)return;const c=Math.max(((M=t.render)==null?void 0:M.font_size)||14,this.MIN_FONT_SIZE),l=c*(((y=t.render)==null?void 0:y.line_height)||1.2);e.save(),e.fillStyle="#000000",e.font=`500 ${c}px "Noto Sans", "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle";const d=this.getAvailableWidth(t),g=this.wrapText(e,u,d),T=g.length*l,m=this.getAvailableHeight(t),f=Math.min(T,m),I=h-f/2+l/2;for(let p=0;p<g.length;p++){const w=I+p*l;w<n+o*.1||w>n+o*.9||e.fillText(g[p],i,w)}e.restore()}wrapText(e,t,s){return!t||t.trim().length===0?[]:/[\u3000-\u9fff\uac00-\ud7af]/.test(t)?this.wrapCJKText(e,t,s):this.wrapLatinText(e,t,s)}wrapCJKText(e,t,s){const n=[];let a="";for(const o of t){if(o===`
`){a&&n.push(a),a="";continue}const i=a+o;e.measureText(i).width>s&&a.length>0?(n.push(a),a=o):a=i}return a&&n.push(a),n}wrapLatinText(e,t,s){const n=t.replace(/\n/g," ").split(/\s+/).filter(i=>i.length>0),a=[];let o="";for(const i of n){const h=o?`${o} ${i}`:i;if(e.measureText(h).width>s&&o.length>0)if(a.push(o),e.measureText(i).width>s){const c=this.breakLongWord(e,i,s);a.push(...c.slice(0,-1)),o=c[c.length-1]||""}else o=i;else o=h}return o&&a.push(o),a}breakLongWord(e,t,s){const n=[];let a="";for(const o of t){const i=a+o;e.measureText(i).width>s&&a.length>0?(n.push(a),a=o):a=i}return a&&n.push(a),n}canvasToBlob(e){return new Promise((t,s)=>{e.toBlob(n=>{n?t(n):s(new Error("Failed to create blob from canvas"))},"image/png",1)})}get(e){const t=this.memoryCache.get(e);return t?(t.timestamp=Date.now(),t.translatedUrl):null}set(e,t){this.memoryCache.set(e,{originalSrc:"",translatedBlob:new Blob,translatedUrl:t,regions:[],width:0,height:0,timestamp:Date.now()}),this.enforceMemoryLimit()}getOriginal(e){var t;return((t=this.memoryCache.get(e))==null?void 0:t.originalSrc)||null}has(e){return this.memoryCache.has(e)}enforceMemoryLimit(){if(this.memoryCache.size<=this.maxMemoryItems)return;const e=Array.from(this.memoryCache.entries()).sort((s,n)=>s[1].timestamp-n[1].timestamp),t=e.slice(0,e.length-this.maxMemoryItems);for(const[s,n]of t)URL.revokeObjectURL(n.translatedUrl),this.memoryCache.delete(s)}clear(){for(const e of this.memoryCache.values())URL.revokeObjectURL(e.translatedUrl);this.memoryCache.clear()}getStats(){return{count:this.memoryCache.size,maxItems:this.maxMemoryItems}}}class P{constructor(){b(this,"cache");b(this,"replacedImages",new Map);this.cache=new O}async replaceWithBase64(e,t,s,n){try{const a=this.replacedImages.get(e);if(a!=null&&a.isShowingTranslated)return!0;const o=(a==null?void 0:a.originalSrc)||e.src;let i=this.cache.get(n);return i||(i=await this.cache.renderAndCache(t,s,n)),i?(e.src=i,this.replacedImages.set(e,{hash:n,originalSrc:o,isShowingTranslated:!0}),e.classList.remove("manga-processing","manga-original"),e.classList.add("manga-translated"),e.dataset.translationHash=n,console.log("[MangaTranslate] Image replaced successfully:",n),!0):(console.error("[MangaTranslate] Failed to render translated image"),!1)}catch(a){return console.error("[MangaTranslate] Failed to replace image:",a),!1}}async replaceWithInpainted(e,t,s,n){try{const a=this.replacedImages.get(e);if(a!=null&&a.isShowingTranslated)return!0;const o=(a==null?void 0:a.originalSrc)||e.src;let i=this.cache.get(n);if(!i){const h=document.createElement("canvas");h.width=t.naturalWidth,h.height=t.naturalHeight,h.getContext("2d").drawImage(t,0,0),i=h.toDataURL("image/png"),this.cache.set(n,i)}return e.src=i,this.replacedImages.set(e,{hash:n,originalSrc:o,isShowingTranslated:!0}),e.classList.remove("manga-processing","manga-original"),e.classList.add("manga-translated"),e.dataset.translationHash=n,console.log("[MangaTranslate] Image replaced with inpainted version:",n),!0}catch(a){return console.error("[MangaTranslate] Failed to replace with inpainted:",a),!1}}renderTextOnCanvas(e,t){const[s,n,a,o]=t.bbox,i=t.tgt_text||"",h=t.render||{},u=h.font_size||14,c=h.font_family||"Arial, sans-serif",l=h.align||"center",d=h.padding||4;e.font=`${u}px ${c}`,e.fillStyle="#000000",e.textAlign=l,e.textBaseline="top";const g=a-d*2,T=i.split(" "),m=[];let f="";for(const p of T){const w=f?`${f} ${p}`:p;e.measureText(w).width>g&&f?(m.push(f),f=p):f=w}f&&m.push(f);const I=u*1.2,M=m.length*I;let y=n+(o-M)/2;for(const p of m){let w;l==="center"?w=s+a/2:l==="right"?w=s+a-d:w=s+d,e.fillText(p,w,y),y+=I}}async replace(e,t,s){return this.replaceWithBase64(e,e,t,s)}restore(e){const t=this.replacedImages.get(e);return t?(e.src=t.originalSrc,t.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original"),!0):!1}toggle(e){const t=this.replacedImages.get(e);if(!t)return!1;if(t.isShowingTranslated)e.src=t.originalSrc,t.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original");else{const s=this.cache.get(t.hash);s&&(e.src=s,t.isShowingTranslated=!0,e.classList.add("manga-translated"),e.classList.remove("manga-original"))}return t.isShowingTranslated}toggleAll(){let e=!1;for(const s of this.replacedImages.values())if(s.isShowingTranslated){e=!0;break}const t=!e;for(const[s,n]of this.replacedImages)if(t&&!n.isShowingTranslated){const a=this.cache.get(n.hash);a&&(s.src=a,n.isShowingTranslated=!0,s.classList.add("manga-translated"),s.classList.remove("manga-original"))}else!t&&n.isShowingTranslated&&(s.src=n.originalSrc,n.isShowingTranslated=!1,s.classList.remove("manga-translated"),s.classList.add("manga-original"));return t}restoreAll(){for(const[e]of this.replacedImages)this.restore(e);this.replacedImages.clear(),this.cache.clear()}isReplaced(e){return this.replacedImages.has(e)}isShowingTranslated(e){var t;return((t=this.replacedImages.get(e))==null?void 0:t.isShowingTranslated)||!1}getStats(){let e=0,t=0;for(const s of this.replacedImages.values())s.isShowingTranslated?e++:t++;return{total:this.replacedImages.size,showingTranslated:e,showingOriginal:t,cache:this.cache.getStats()}}}const _=new P;let L=!1,S=null,B=0,C=0;const F=4;function E(r){const e=`${r.src}_${r.naturalWidth}_${r.naturalHeight}`;let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t=t&t;return Math.abs(t).toString(16)}function U(){const r=document.querySelectorAll("img"),e=[];return r.forEach(t=>{if(!t.complete||t.naturalWidth===0||t.naturalWidth<300||t.naturalHeight<400||t.width<100||t.height<100||t.src.startsWith("data:")&&t.src.length<1e3)return;const s=t.naturalWidth/t.naturalHeight;s<.3||s>1.5||_.isReplaced(t)||e.push(t)}),e}async function H(r){const e=await chrome.runtime.sendMessage({action:"fetchImageAsBase64",data:{url:r.src}});if(e!=null&&e.success&&e.base64)return e.base64;try{const t=document.createElement("canvas");return t.width=r.naturalWidth,t.height=r.naturalHeight,t.getContext("2d").drawImage(r,0,0),t.toDataURL("image/png")}catch{throw new Error("Could not convert image (CORS blocked)")}}function A(r){return new Promise((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=()=>t(new Error("Failed to load image from base64")),r.startsWith("data:")?s.src=r:s.src="data:image/png;base64,"+r})}async function R(){const r=await chrome.runtime.sendMessage({action:"getSettings"});return r!=null&&r.success?r.settings:{backendUrl:"http://127.0.0.1:5000",sourceLang:"ja",targetLang:"id",useSam:!1,useAdvanced:!1,detectOsb:!0,useInpainting:!0,inpaintMethod:"opencv",renderText:!0,batchSize:F}}function v(r,e){console.log(`[MangaTranslate] ${r} (${e}%)`),chrome.runtime.sendMessage({action:"updateProgress",data:{message:r,percent:e}}).catch(()=>{})}async function D(r,e){var s;const t=e.batchSize||F;for(let n=0;n<r.length;n+=t){const a=r.slice(n,n+t),o=Math.floor(n/t)+1,i=Math.ceil(r.length/t);v(`Processing batch ${o}/${i} (${a.length} images)`,Math.round(n/r.length*90)+10);const h=a.map(async(l,d)=>{try{const g=await H(l);return{image_id:`img_${n+d}_${E(l)}`,image_b64:g,element:l,error:null}}catch(g){return{image_id:`img_${n+d}`,image_b64:"",element:l,error:g.message}}}),c=(await Promise.all(h)).filter(l=>!l.error&&l.image_b64);if(c.length===0){C+=a.length;continue}try{const l=await chrome.runtime.sendMessage({action:"translateBatch",data:{images:c.map(d=>({image_id:d.image_id,image_b64:d.image_b64})),source_lang:e.sourceLang,target_lang:e.targetLang,detect_osb:e.detectOsb,use_inpainting:e.useInpainting,inpaint_method:e.inpaintMethod,use_sam:e.useSam,use_advanced:e.useAdvanced,render_text:e.renderText}});if(l!=null&&l.success){const d=l.results;for(const g of d){const T=c.find(m=>m.image_id===g.image_id);if(T){if(g.error){console.log(`[MangaTranslate] Image ${g.image_id} failed: ${g.error}`);continue}if(g.image_b64&&((s=g.regions)!=null&&s.length))try{const m=await A(g.image_b64);await _.replaceWithInpainted(T.element,m,g.regions,g.image_id)}catch(m){console.log(`[MangaTranslate] Failed to apply result for ${g.image_id}:`,m)}}}console.log(`[MangaTranslate] Batch ${o} complete: ${d.length} images processed`)}else{console.error("[MangaTranslate] Batch translation failed:",l==null?void 0:l.error);for(const d of c)await k(d.element,e)}}catch(l){console.error("[MangaTranslate] Batch request error:",l);for(const d of c)await k(d.element)}C+=a.length}}async function k(r,e){var s;const t=E(r);try{const n=await H(r),a=await chrome.runtime.sendMessage({action:"translate",data:{imageHash:t,imageBase64:n}});if(!(a!=null&&a.success))return console.log("[MangaTranslate] Translation failed:",a==null?void 0:a.error),!1;if(!((s=a.regions)!=null&&s.length))return console.log("[MangaTranslate] No text regions found"),!1;if(a.image_b64)try{const i=await A(a.image_b64);return await _.replaceWithInpainted(r,i,a.regions,t)}catch{console.log("[MangaTranslate] Failed to load processed image")}const o=await A(n);return await _.replaceWithBase64(r,o,a.regions,t)}catch(n){return console.error("[MangaTranslate] Error processing image:",n),!1}}async function X(){if(L)return;L=!0,v("Loading settings...",0),S=await R();const r=[];S.useSam&&r.push("SAM2"),S.useAdvanced&&r.push("Advanced"),S.detectOsb&&r.push("OSB"),S.useInpainting&&r.push(`Inpaint:${S.inpaintMethod}`),console.log(`[MangaTranslate] Features: ${r.join(", ")||"default"}`),console.log(`[MangaTranslate] Batch size: ${S.batchSize||F}`),v("Finding images...",5);const e=U();if(e.length===0){v("No manga images found",100),L=!1;return}B=e.length,C=0,v(`Found ${B} images, processing in batches...`,10),await D(e,S);const t=_.getStats();v(`Done! ${t.showingTranslated} images translated`,100),L=!1}chrome.runtime.onMessage.addListener((r,e,t)=>{switch(r.action){case"translatePage":X(),t({success:!0});break;case"toggleOverlay":const s=_.toggleAll();t({success:!0,showingTranslated:s});break;case"clearOverlays":_.restoreAll(),t({success:!0});break;case"getStats":t({success:!0,stats:_.getStats(),isProcessing:L});break}return!0});const N=document.createElement("style");N.textContent=`
  .manga-translated {
    outline: 2px solid #4CAF50;
    outline-offset: -2px;
  }
  .manga-original {
    outline: 2px dashed #888;
    outline-offset: -2px;
  }
  .manga-processing {
    outline: 2px solid #FF9800;
    outline-offset: -2px;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
`;document.head.appendChild(N);console.log("[MangaTranslate] Content script loaded (Batch Processing Mode)");
