var H=Object.defineProperty;var N=(r,e,t)=>e in r?H(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var y=(r,e,t)=>N(r,typeof e!="symbol"?e+"":e,t);class U{constructor(){y(this,"memoryCache",new Map);y(this,"maxMemoryItems",50);y(this,"MIN_TEXT_GAP",4);y(this,"MIN_FONT_SIZE",8);y(this,"MAX_FONT_SIZE",28)}async renderAndCache(e,t,a){console.log("[MangaTranslate Cache] Rendering image:",a,"with",t.length,"regions");const s=document.createElement("canvas");s.width=e.naturalWidth,s.height=e.naturalHeight;const n=s.getContext("2d");if(!n)throw new Error("Failed to get canvas context");try{n.drawImage(e,0,0),console.log("[MangaTranslate Cache] Original image drawn on canvas")}catch(h){throw console.error("[MangaTranslate Cache] Failed to draw image on canvas:",h),h}const o=[...t].sort((h,m)=>h.bbox[1]-m.bbox[1]);for(const h of o)this.drawMask(n,h);const i=this.optimizeFontSizes(n,o);for(const h of i)this.renderText(n,h);console.log("[MangaTranslate Cache] All bubbles rendered");const l=await this.canvasToBlob(s),c=URL.createObjectURL(l);return console.log("[MangaTranslate Cache] Created blob URL:",c),this.memoryCache.set(a,{originalSrc:e.src,translatedBlob:l,translatedUrl:c,regions:t,width:e.naturalWidth,height:e.naturalHeight,timestamp:Date.now()}),this.enforceMemoryLimit(),c}optimizeFontSizes(e,t){var n,o;const a=[],s=[];for(const i of t){const[l,c,h,m]=i.bbox,p=i.tgt_text;if(!p||p.trim().length===0){a.push(i);continue}const T=this.getAvailableWidth(i),M=this.getAvailableHeight(i);let g=Math.min(((n=i.render)==null?void 0:n.font_size)||14,this.MAX_FONT_SIZE,Math.floor(M/3),Math.floor(T/3)),d=null;for(;g>=this.MIN_FONT_SIZE;){e.font=`500 ${g}px "Noto Sans", "Segoe UI", Arial, sans-serif`;const I=g*(((o=i.render)==null?void 0:o.line_height)||1.2),S=this.wrapText(e,p,T*.9),w=S.length*I;if(w<=M*.9){const u=Math.max(...S.map(A=>e.measureText(A).width)),f=l+h/2,F=c+m/2;if(d={x:f-u/2-this.MIN_TEXT_GAP,y:F-w/2-this.MIN_TEXT_GAP,width:u+this.MIN_TEXT_GAP*2,height:w+this.MIN_TEXT_GAP*2,regionId:i.id},!s.some(A=>this.checkCollision(d,A)))break}g-=1}d&&g>=this.MIN_FONT_SIZE&&s.push(d),a.push({...i,render:{...i.render,font_size:Math.max(g,this.MIN_FONT_SIZE)}})}return a}checkCollision(e,t){return!(e.x+e.width<t.x||t.x+t.width<e.x||e.y+e.height<t.y||t.y+t.height<e.y)}getAvailableWidth(e){const[,,t]=e.bbox;switch(e.mask_type){case"ellipse":return t*.7;case"rect":return t*.85;default:return t*.75}}getAvailableHeight(e){const[,,,t]=e.bbox;switch(e.mask_type){case"ellipse":return t*.65;case"rect":return t*.85;default:return t*.7}}drawMask(e,t){const[a,s,n,o]=t.bbox,i=a+n/2,l=s+o/2;if(e.save(),e.fillStyle="#FFFFFF",t.polygon&&t.polygon.length>=3){e.beginPath(),e.moveTo(t.polygon[0][0],t.polygon[0][1]);for(let c=1;c<t.polygon.length;c++)e.lineTo(t.polygon[c][0],t.polygon[c][1]);e.closePath(),e.fill()}else switch(t.mask_type){case"rect":e.fillRect(a+2,s+2,n-4,o-4);break;case"ellipse":default:e.beginPath(),e.ellipse(i,l,n/2*.92,o/2*.92,0,0,Math.PI*2),e.fill();break}e.restore()}renderText(e,t){var S,w;const[a,s,n,o]=t.bbox,i=a+n/2,l=s+o/2,c=t.tgt_text;if(!c||c.trim().length===0)return;const h=Math.max(((S=t.render)==null?void 0:S.font_size)||14,this.MIN_FONT_SIZE),m=h*(((w=t.render)==null?void 0:w.line_height)||1.2);e.save(),e.fillStyle="#000000",e.font=`500 ${h}px "Noto Sans", "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle";const p=this.getAvailableWidth(t),T=this.wrapText(e,c,p),M=T.length*m,g=this.getAvailableHeight(t),d=Math.min(M,g),I=l-d/2+m/2;for(let u=0;u<T.length;u++){const f=I+u*m;f<s+o*.1||f>s+o*.9||e.fillText(T[u],i,f)}e.restore()}wrapText(e,t,a){return!t||t.trim().length===0?[]:/[\u3000-\u9fff\uac00-\ud7af]/.test(t)?this.wrapCJKText(e,t,a):this.wrapLatinText(e,t,a)}wrapCJKText(e,t,a){const s=[];let n="";for(const o of t){if(o===`
`){n&&s.push(n),n="";continue}const i=n+o;e.measureText(i).width>a&&n.length>0?(s.push(n),n=o):n=i}return n&&s.push(n),s}wrapLatinText(e,t,a){const s=t.replace(/\n/g," ").split(/\s+/).filter(i=>i.length>0),n=[];let o="";for(const i of s){const l=o?`${o} ${i}`:i;if(e.measureText(l).width>a&&o.length>0)if(n.push(o),e.measureText(i).width>a){const h=this.breakLongWord(e,i,a);n.push(...h.slice(0,-1)),o=h[h.length-1]||""}else o=i;else o=l}return o&&n.push(o),n}breakLongWord(e,t,a){const s=[];let n="";for(const o of t){const i=n+o;e.measureText(i).width>a&&n.length>0?(s.push(n),n=o):n=i}return n&&s.push(n),s}canvasToBlob(e){return new Promise((t,a)=>{e.toBlob(s=>{s?t(s):a(new Error("Failed to create blob from canvas"))},"image/png",1)})}get(e){const t=this.memoryCache.get(e);return t?(t.timestamp=Date.now(),t.translatedUrl):null}set(e,t){this.memoryCache.set(e,{originalSrc:"",translatedBlob:new Blob,translatedUrl:t,regions:[],width:0,height:0,timestamp:Date.now()}),this.enforceMemoryLimit()}getOriginal(e){var t;return((t=this.memoryCache.get(e))==null?void 0:t.originalSrc)||null}has(e){return this.memoryCache.has(e)}enforceMemoryLimit(){if(this.memoryCache.size<=this.maxMemoryItems)return;const e=Array.from(this.memoryCache.entries()).sort((a,s)=>a[1].timestamp-s[1].timestamp),t=e.slice(0,e.length-this.maxMemoryItems);for(const[a,s]of t)URL.revokeObjectURL(s.translatedUrl),this.memoryCache.delete(a)}clear(){for(const e of this.memoryCache.values())URL.revokeObjectURL(e.translatedUrl);this.memoryCache.clear()}getStats(){return{count:this.memoryCache.size,maxItems:this.maxMemoryItems}}}class W{constructor(){y(this,"cache");y(this,"replacedImages",new Map);this.cache=new U}async replaceWithBase64(e,t,a,s){try{const n=this.replacedImages.get(e);if(n!=null&&n.isShowingTranslated)return!0;const o=(n==null?void 0:n.originalSrc)||e.src;let i=this.cache.get(s);return i||(i=await this.cache.renderAndCache(t,a,s)),i?(e.src=i,this.replacedImages.set(e,{hash:s,originalSrc:o,isShowingTranslated:!0}),e.classList.remove("manga-processing","manga-original"),e.classList.add("manga-translated"),e.dataset.translationHash=s,console.log("[MangaTranslate] Image replaced successfully:",s),!0):(console.error("[MangaTranslate] Failed to render translated image"),!1)}catch(n){return console.error("[MangaTranslate] Failed to replace image:",n),!1}}async replaceWithInpainted(e,t,a,s){try{const n=this.replacedImages.get(e);if(n!=null&&n.isShowingTranslated)return!0;const o=(n==null?void 0:n.originalSrc)||e.src;let i=this.cache.get(s);if(!i){const l=document.createElement("canvas");l.width=t.naturalWidth,l.height=t.naturalHeight,l.getContext("2d").drawImage(t,0,0),i=l.toDataURL("image/png"),this.cache.set(s,i)}return e.src=i,this.replacedImages.set(e,{hash:s,originalSrc:o,isShowingTranslated:!0}),e.classList.remove("manga-processing","manga-original"),e.classList.add("manga-translated"),e.dataset.translationHash=s,console.log("[MangaTranslate] Image replaced with inpainted version:",s),!0}catch(n){return console.error("[MangaTranslate] Failed to replace with inpainted:",n),!1}}renderTextOnCanvas(e,t){const[a,s,n,o]=t.bbox,i=t.tgt_text||"",l=t.render||{},c=l.font_size||14,h=l.font_family||"Arial, sans-serif",m=l.align||"center",p=l.padding||4;e.font=`${c}px ${h}`,e.fillStyle="#000000",e.textAlign=m,e.textBaseline="top";const T=n-p*2,M=i.split(" "),g=[];let d="";for(const u of M){const f=d?`${d} ${u}`:u;e.measureText(f).width>T&&d?(g.push(d),d=u):d=f}d&&g.push(d);const I=c*1.2,S=g.length*I;let w=s+(o-S)/2;for(const u of g){let f;m==="center"?f=a+n/2:m==="right"?f=a+n-p:f=a+p,e.fillText(u,f,w),w+=I}}async replace(e,t,a){return this.replaceWithBase64(e,e,t,a)}restore(e){const t=this.replacedImages.get(e);return t?(e.src=t.originalSrc,t.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original"),!0):!1}toggle(e){const t=this.replacedImages.get(e);if(!t)return!1;if(t.isShowingTranslated)e.src=t.originalSrc,t.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original");else{const a=this.cache.get(t.hash);a&&(e.src=a,t.isShowingTranslated=!0,e.classList.add("manga-translated"),e.classList.remove("manga-original"))}return t.isShowingTranslated}toggleAll(){let e=!1;for(const a of this.replacedImages.values())if(a.isShowingTranslated){e=!0;break}const t=!e;for(const[a,s]of this.replacedImages)if(t&&!s.isShowingTranslated){const n=this.cache.get(s.hash);n&&(a.src=n,s.isShowingTranslated=!0,a.classList.add("manga-translated"),a.classList.remove("manga-original"))}else!t&&s.isShowingTranslated&&(a.src=s.originalSrc,s.isShowingTranslated=!1,a.classList.remove("manga-translated"),a.classList.add("manga-original"));return t}restoreAll(){for(const[e]of this.replacedImages)this.restore(e);this.replacedImages.clear(),this.cache.clear()}isReplaced(e){return this.replacedImages.has(e)}isShowingTranslated(e){var t;return((t=this.replacedImages.get(e))==null?void 0:t.isShowingTranslated)||!1}getStats(){let e=0,t=0;for(const a of this.replacedImages.values())a.isShowingTranslated?e++:t++;return{total:this.replacedImages.size,showingTranslated:e,showingOriginal:t,cache:this.cache.getStats()}}}const b=new W;let L=!1,v=null,_=0,C=0;function O(r){const e=`${r.src}_${r.naturalWidth}_${r.naturalHeight}`;let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t=t&t;return Math.abs(t).toString(16)}function $(){const r=document.querySelectorAll("img"),e=[];return r.forEach(t=>{if(!t.complete||t.naturalWidth===0||t.naturalWidth<300||t.naturalHeight<400||t.width<100||t.height<100||t.src.startsWith("data:")&&t.src.length<1e3)return;const a=t.naturalWidth/t.naturalHeight;a<.3||a>1.5||b.isReplaced(t)||e.push(t)}),e}async function B(r){const e=await chrome.runtime.sendMessage({action:"fetchImageAsBase64",data:{url:r.src}});if(e!=null&&e.success&&e.base64)return e.base64;try{const t=document.createElement("canvas");return t.width=r.naturalWidth,t.height=r.naturalHeight,t.getContext("2d").drawImage(r,0,0),t.toDataURL("image/png")}catch{throw new Error("Could not convert image (CORS blocked)")}}function k(r){return new Promise((e,t)=>{const a=new Image;a.onload=()=>e(a),a.onerror=()=>t(new Error("Failed to load image from base64")),r.startsWith("data:")?a.src=r:a.src="data:image/png;base64,"+r})}async function P(){const r=await chrome.runtime.sendMessage({action:"getSettings"});return r!=null&&r.success?r.settings:{backendUrl:"http://127.0.0.1:5000",sourceLang:"ja",targetLang:"id",useSam:!1,useAdvanced:!1,detectOsb:!0,useInpainting:!0,inpaintMethod:"opencv",renderText:!0}}async function z(r){var t;const e=O(r);try{const a=await B(r),s=await chrome.runtime.sendMessage({action:"translate",data:{imageHash:e,imageBase64:a}});if(!(s!=null&&s.success))return console.log("[MangaTranslate] Translation failed:",s==null?void 0:s.error),!1;if(!((t=s.regions)!=null&&t.length))return console.log("[MangaTranslate] No text regions found"),!1;if(s.image_b64)try{const o=await k(s.image_b64);return await b.replaceWithInpainted(r,o,s.regions,e)}catch{console.log("[MangaTranslate] Failed to load processed image, using canvas")}const n=await k(a);return await b.replaceWithBase64(r,n,s.regions,e)}catch(a){return console.error("[MangaTranslate] Error processing image:",a),!1}}function x(r,e){console.log(`[MangaTranslate] ${r} (${e}%)`)}async function R(){if(L)return;L=!0,x("Loading settings...",0),v=await P();const r=[];v.useSam&&r.push("SAM2"),v.useAdvanced&&r.push("Advanced"),v.detectOsb&&r.push("OSB"),v.useInpainting&&r.push(`Inpaint:${v.inpaintMethod}`),console.log(`[MangaTranslate] Features: ${r.join(", ")||"default"}`),x("Finding images...",5);const e=$();if(e.length===0){x("No manga images found",100),L=!1;return}_=e.length,C=0,x(`Found ${_} images...`,10);for(const a of e){const s=await z(a);C++,x(`Translating ${C}/${_}${s?"":" (skipped)"}`,Math.round(10+C/_*90))}const t=b.getStats();x(`Done! ${t.showingTranslated} images translated`,100),L=!1}chrome.runtime.onMessage.addListener((r,e,t)=>{switch(r.action){case"translatePage":R(),t({success:!0});break;case"toggleOverlay":const a=b.toggleAll();t({success:!0,showingTranslated:a});break;case"clearOverlays":b.restoreAll(),t({success:!0});break;case"getStats":t({success:!0,stats:b.getStats(),isProcessing:L});break}return!0});const E=document.createElement("style");E.textContent=`
  .manga-translated {
    outline: 2px solid #4CAF50;
    outline-offset: -2px;
  }
  .manga-original {
    outline: 2px dashed #888;
    outline-offset: -2px;
  }
  .manga-processing {
    outline: 2px solid #FF9800;
    outline-offset: -2px;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
`;document.head.appendChild(E);console.log("[MangaTranslate] Content script loaded (Unified API)");
