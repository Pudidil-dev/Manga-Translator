var U=Object.defineProperty;var A=(n,e,a)=>e in n?U(n,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[e]=a;var g=(n,e,a)=>A(n,typeof e!="symbol"?e+"":e,a);class B{constructor(){g(this,"memoryCache",new Map);g(this,"maxMemoryItems",50)}async renderAndCache(e,a,t){console.log("[MangaTranslate Cache] Rendering image:",t,"with",a.length,"regions");const s=document.createElement("canvas");s.width=e.naturalWidth,s.height=e.naturalHeight;const r=s.getContext("2d");if(!r)throw new Error("Failed to get canvas context");try{r.drawImage(e,0,0),console.log("[MangaTranslate Cache] Original image drawn on canvas")}catch(i){throw console.error("[MangaTranslate Cache] Failed to draw image on canvas:",i),i}for(const i of a)this.renderBubble(r,i);console.log("[MangaTranslate Cache] All bubbles rendered");const o=await this.canvasToBlob(s),l=URL.createObjectURL(o);return console.log("[MangaTranslate Cache] Created blob URL:",l),this.memoryCache.set(t,{originalSrc:e.src,translatedBlob:o,translatedUrl:l,regions:a,width:e.naturalWidth,height:e.naturalHeight,timestamp:Date.now()}),this.enforceMemoryLimit(),l}renderBubble(e,a){var S,b;const[t,s,r,o]=a.bbox,l=t+r/2,i=s+o/2;if(console.log("[MangaTranslate Cache] Rendering bubble:",a.id,"at",t,s,r,o),console.log("[MangaTranslate Cache] Text:",a.src_text,"->",a.tgt_text),e.save(),e.fillStyle="#FFFFFF",a.polygon&&a.polygon.length>=3){e.beginPath(),e.moveTo(a.polygon[0][0],a.polygon[0][1]);for(let c=1;c<a.polygon.length;c++)e.lineTo(a.polygon[c][0],a.polygon[c][1]);e.closePath(),e.fill()}else switch(a.mask_type){case"rect":e.fillRect(t+2,s+2,r-4,o-4);break;case"ellipse":default:e.beginPath(),e.ellipse(l,i,r/2*.92,o/2*.92,0,0,Math.PI*2),e.fill();break}e.restore();const m=a.tgt_text;if(!m||m.trim().length===0){console.log("[MangaTranslate Cache] No text to render for region:",a.id);return}const y=((S=a.render)==null?void 0:S.font_size)||14;e.save(),e.fillStyle="#000000",e.font=`500 ${y}px "Noto Sans", "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle";const M=r*.85,f=this.wrapText(e,m,M),T=y*(((b=a.render)==null?void 0:b.line_height)||1.25),v=f.length*T,x=i-v/2+T/2;for(let c=0;c<f.length;c++)e.fillText(f[c],l,x+c*T);e.restore(),console.log("[MangaTranslate Cache] Rendered",f.length,"lines of text")}wrapText(e,a,t){return/[\u3000-\u9fff\uac00-\ud7af]/.test(a)?this.wrapCJKText(e,a,t):this.wrapLatinText(e,a,t)}wrapCJKText(e,a,t){const s=[];let r="";for(const o of a){const l=r+o;e.measureText(l).width>t&&r.length>0?(s.push(r),r=o):r=l}return r&&s.push(r),s}wrapLatinText(e,a,t){const s=a.split(" "),r=[];let o="";for(const l of s){const i=o?`${o} ${l}`:l;e.measureText(i).width>t&&o.length>0?(r.push(o),o=l):o=i}return o&&r.push(o),r}canvasToBlob(e){return new Promise((a,t)=>{e.toBlob(s=>{s?(console.log("[MangaTranslate Cache] Canvas converted to blob, size:",s.size),a(s)):t(new Error("Failed to create blob from canvas"))},"image/png",1)})}get(e){const a=this.memoryCache.get(e);return a?(a.timestamp=Date.now(),a.translatedUrl):null}getOriginal(e){var a;return((a=this.memoryCache.get(e))==null?void 0:a.originalSrc)||null}has(e){return this.memoryCache.has(e)}enforceMemoryLimit(){if(this.memoryCache.size<=this.maxMemoryItems)return;const e=Array.from(this.memoryCache.entries()).sort((t,s)=>t[1].timestamp-s[1].timestamp),a=e.slice(0,e.length-this.maxMemoryItems);for(const[t,s]of a)URL.revokeObjectURL(s.translatedUrl),this.memoryCache.delete(t)}clear(){for(const e of this.memoryCache.values())URL.revokeObjectURL(e.translatedUrl);this.memoryCache.clear()}getStats(){return{count:this.memoryCache.size,maxItems:this.maxMemoryItems}}}class F{constructor(){g(this,"cache");g(this,"replacedImages",new Map);this.cache=new B}async replaceWithBase64(e,a,t,s){try{const r=this.replacedImages.get(e);if(r!=null&&r.isShowingTranslated)return!0;const o=(r==null?void 0:r.originalSrc)||e.src;let l=this.cache.get(s);return l||(l=await this.cache.renderAndCache(a,t,s)),l?(e.src=l,this.replacedImages.set(e,{hash:s,originalSrc:o,isShowingTranslated:!0}),e.classList.remove("manga-processing","manga-original"),e.classList.add("manga-translated"),e.dataset.translationHash=s,console.log("[MangaTranslate] Image replaced successfully:",s),!0):(console.error("[MangaTranslate] Failed to render translated image"),!1)}catch(r){return console.error("[MangaTranslate] Failed to replace image:",r),!1}}async replace(e,a,t){return this.replaceWithBase64(e,e,a,t)}restore(e){const a=this.replacedImages.get(e);return a?(e.src=a.originalSrc,a.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original"),!0):!1}toggle(e){const a=this.replacedImages.get(e);if(!a)return!1;if(a.isShowingTranslated)e.src=a.originalSrc,a.isShowingTranslated=!1,e.classList.remove("manga-translated"),e.classList.add("manga-original");else{const t=this.cache.get(a.hash);t&&(e.src=t,a.isShowingTranslated=!0,e.classList.add("manga-translated"),e.classList.remove("manga-original"))}return a.isShowingTranslated}toggleAll(){let e=!1;for(const t of this.replacedImages.values())if(t.isShowingTranslated){e=!0;break}const a=!e;for(const[t,s]of this.replacedImages)if(a&&!s.isShowingTranslated){const r=this.cache.get(s.hash);r&&(t.src=r,s.isShowingTranslated=!0,t.classList.add("manga-translated"),t.classList.remove("manga-original"))}else!a&&s.isShowingTranslated&&(t.src=s.originalSrc,s.isShowingTranslated=!1,t.classList.remove("manga-translated"),t.classList.add("manga-original"));return a}restoreAll(){for(const[e]of this.replacedImages)this.restore(e);this.replacedImages.clear(),this.cache.clear()}isReplaced(e){return this.replacedImages.has(e)}isShowingTranslated(e){var a;return((a=this.replacedImages.get(e))==null?void 0:a.isShowingTranslated)||!1}getStats(){let e=0,a=0;for(const t of this.replacedImages.values())t.isShowingTranslated?e++:a++;return{total:this.replacedImages.size,showingTranslated:e,showingOriginal:a,cache:this.cache.getStats()}}}const h=new F;let u=!1,C="ja",L="id",p=0,w=0;function R(n){const e=`${n.src}_${n.naturalWidth}_${n.naturalHeight}`;let a=0;for(let t=0;t<e.length;t++)a=(a<<5)-a+e.charCodeAt(t),a=a&a;return Math.abs(a).toString(16)}function k(){const n=document.querySelectorAll("img"),e=[];return n.forEach(a=>{if(!a.complete||a.naturalWidth===0||a.naturalWidth<300||a.naturalHeight<400||a.width<100||a.height<100||a.src.startsWith("data:")&&a.src.length<1e3)return;const t=a.naturalWidth/a.naturalHeight;t<.3||t>1.5||h.isReplaced(a)||e.push(a)}),e}async function H(n){const e=await chrome.runtime.sendMessage({action:"fetchImageAsBase64",data:{url:n.src}});if(e!=null&&e.success&&e.base64)return e.base64;try{const a=document.createElement("canvas");return a.width=n.naturalWidth,a.height=n.naturalHeight,a.getContext("2d").drawImage(n,0,0),a.toDataURL("image/png")}catch{throw new Error("Could not convert image (CORS blocked)")}}function P(n){return new Promise((e,a)=>{const t=new Image;t.onload=()=>e(t),t.onerror=()=>a(new Error("Failed to load image from base64")),t.src=n})}async function W(n){var a;const e=R(n);try{const t=await H(n),s=await chrome.runtime.sendMessage({action:"translateImage",data:{imageHash:e,imageBase64:t,sourceLang:C,targetLang:L}});if(!(s!=null&&s.success))return console.log("[MangaTranslate] Translation failed:",s==null?void 0:s.error),!1;if(!((a=s.regions)!=null&&a.length))return console.log("[MangaTranslate] No text regions found in image"),!1;const r=await P(t);return await h.replaceWithBase64(n,r,s.regions,e)}catch(t){return console.error("[MangaTranslate] Error processing image:",t),!1}}function d(n,e){chrome.runtime.sendMessage({action:"updateProgress",data:{message:n,percent:e}})}async function $(){if(u)return;u=!0,d("Finding images...",0);const n=k();if(n.length===0){d("No manga images found",100),u=!1;return}p=n.length,w=0,d(`Found ${p} images, starting translation...`,5);const e=2;for(let t=0;t<n.length;t+=e){const s=n.slice(t,t+e);await Promise.all(s.map(async r=>{const o=await W(r);w++,d(`Translating ${w}/${p}${o?"":" (skipped)"}`,Math.round(w/p*100))}))}const a=h.getStats();d(`Done! ${a.showingTranslated} images translated`,100),u=!1}chrome.runtime.onMessage.addListener((n,e,a)=>{switch(n.action){case"translatePage":C=n.sourceLang||"ja",L=n.targetLang||"id",$(),a({success:!0});break;case"toggleOverlay":const t=h.toggleAll();a({success:!0,showingTranslated:t});break;case"clearOverlays":h.restoreAll(),a({success:!0});break;case"getStats":a({success:!0,stats:h.getStats(),isProcessing:u});break}return!0});const I=document.createElement("style");I.textContent=`
  .manga-translated {
    outline: 2px solid #e94560;
    outline-offset: -2px;
  }
  .manga-original {
    outline: 2px dashed #888;
    outline-offset: -2px;
  }
  .manga-processing {
    outline: 2px solid #ffa500;
    outline-offset: -2px;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
`;document.head.appendChild(I);console.log("[MangaTranslate] Content script loaded");
